!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).DGGS={})}(this,function(t){"use strict";function y(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function r(t,e,r){return e&&i(t.prototype,e),r&&i(t,r),t}function e(e,t){var r,i=Object.keys(e);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(e),t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,r)),i}function n(n){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?e(Object(a),!0).forEach(function(t){var e,r,i;e=n,i=a[r=t],r in e?Object.defineProperty(e,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[r]=i}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):e(Object(a)).forEach(function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(a,t))})}return n}function a(t){return function(t){if(Array.isArray(t))return o(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return o(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);"Object"===r&&t.constructor&&(r=t.constructor.name);if("Map"===r||"Set"===r)return Array.from(t);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return o(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,i=new Array(e);r<e;r++)i[r]=t[r];return i}var V=1e-6,s="undefined"!=typeof Float32Array?Float32Array:Array,Q=Math.PI/180;function c(){var t=new s(16);return s!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function _(){var t=new s(3);return s!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function f(t){var e=new s(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function h(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function w(t,e,r,i){var n=e[0],a=e[1],o=e[2];return t[0]=n+i*(r[0]-n),t[1]=a+i*(r[1]-a),t[2]=o+i*(r[2]-o),t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var l;l=_();function P(){var t=new s(2);return s!=Float32Array&&(t[0]=0,t[1]=0),t}function x(t){var e=new s(2);return e[0]=t[0],e[1]=t[1],e}var u,F=function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t},v=(u=P(),function(){function e(t){y(this,e),this.position=f([0,0,0]),this.target=f([0,0,0]),this.up=f([0,1,0]),this.viewMatrix=c(),this.projectionMatrix=c(),this.projectionMatrixInverse=c(),this.needUpdateViewMat=!0,this.needUpdateProjMat=!0,this.zoom=.9,this.type=void 0!==t.type?t.type:"OrthoCamera","OrthoCamera"===t.type?(this.left=void 0!==t.left?t.left:-1,this.right=void 0!==t.right?t.right:1,this.top=void 0!==t.top?t.top:1,this.bottom=void 0!==t.bottom?t.bottom:-1,this.near=void 0!==t.near?t.near:-1,this.far=void 0!==t.far?t.far:1):"PerspectiveCamera"===t.type&&(this.fov=void 0!==t.fov?t.fov:45,this.aspect=void 0!==t.aspect?t.aspect:1,this.near=void 0!==t.near?t.near:.1,this.far=void 0!==t.far?t.far:1e3),this.updateProjectionMatrix()}return r(e,[{key:"setPosition",value:function(t,e,r){this.position=f([t,e,r]),this.updateViewMatrix()}},{key:"setUp",value:function(t,e,r){this.up=f([t,e,r]),this.updateViewMatrix()}},{key:"setZoom",value:function(t){this.zoom=t,this.updateProjectionMatrix()}},{key:"lookAt",value:function(t,e,r){this.target=f([t,e,r]),this.updateViewMatrix()}},{key:"updateViewMatrix",value:function(){var t,e,r,i,n,a,o,s,c,h,l,u,f,v,m,d,p,g,y,b,A,M,_,w;t=this.viewMatrix,e=this.position,r=this.target,i=this.up,d=e[0],p=e[1],g=e[2],y=i[0],b=i[1],A=i[2],M=r[0],_=r[1],w=r[2],Math.abs(d-M)<V&&Math.abs(p-_)<V&&Math.abs(g-w)<V?((m=t)[0]=1,m[1]=0,m[2]=0,m[3]=0,m[4]=0,m[5]=1,m[6]=0,m[7]=0,m[8]=0,m[9]=0,m[10]=1,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1):(l=d-M,u=p-_,f=g-w,n=b*(f*=v=1/Math.hypot(l,u,f))-A*(u*=v),a=A*(l*=v)-y*f,o=y*u-b*l,(v=Math.hypot(n,a,o))?(n*=v=1/v,a*=v,o*=v):o=a=n=0,s=u*o-f*a,c=f*n-l*o,h=l*a-u*n,(v=Math.hypot(s,c,h))?(s*=v=1/v,c*=v,h*=v):h=c=s=0,t[0]=n,t[1]=s,t[2]=l,t[3]=0,t[4]=a,t[5]=c,t[6]=u,t[7]=0,t[8]=o,t[9]=h,t[10]=f,t[11]=0,t[12]=-(n*d+a*p+o*g),t[13]=-(s*d+c*p+h*g),t[14]=-(l*d+u*p+f*g),t[15]=1),this.needUpdateViewMat=!0}},{key:"updateProjectionMatrix",value:function(){var t,e,r,i,n,a,o,s,c,h,l,u,f,v,m,d,p,g,y,b,A,M,_,w,V,P,x,F,T,E,k,S,C,U,I,R,O,j,D,L,z,B,G,N,H,q,Y,W,Z,X,$,K,J;"OrthoCamera"===this.type?(t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,i=(this.top+this.bottom)/2,f=this.projectionMatrix,v=r-t,m=r+t,d=i-e,p=i+e,g=this.near,y=this.far,b=1/(v-m),A=1/(d-p),M=1/(g-y),f[0]=-2*b,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=-2*A,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[10]=2*M,f[11]=0,f[12]=(v+m)*b,f[13]=(p+d)*A,f[14]=(y+g)*M,f[15]=1):"PerspectiveCamera"===this.type&&(n=this.fov/this.zoom*Q,a=this.projectionMatrix,o=n,s=this.aspect,c=this.near,h=this.far,u=1/Math.tan(o/2),a[0]=u/s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=u,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[11]=-1,a[12]=0,a[13]=0,a[15]=0,null!=h&&h!==1/0?(l=1/(c-h),a[10]=(h+c)*l,a[14]=2*h*c*l):(a[10]=-1,a[14]=-2*c)),_=this.projectionMatrixInverse,w=this.projectionMatrix,V=w[0],P=w[1],x=w[2],F=w[3],T=w[4],E=w[5],k=w[6],S=w[7],C=w[8],U=w[9],I=w[10],R=w[11],O=w[12],j=w[13],D=w[14],L=w[15],(J=(z=V*E-P*T)*(K=I*L-R*D)-(B=V*k-x*T)*($=U*L-R*j)+(G=V*S-F*T)*(X=U*D-I*j)+(N=P*k-x*E)*(Z=C*L-R*O)-(H=P*S-F*E)*(W=C*D-I*O)+(q=x*S-F*k)*(Y=C*j-U*O))&&(J=1/J,_[0]=(E*K-k*$+S*X)*J,_[1]=(x*$-P*K-F*X)*J,_[2]=(j*q-D*H+L*N)*J,_[3]=(I*H-U*q-R*N)*J,_[4]=(k*Z-T*K-S*W)*J,_[5]=(V*K-x*Z+F*W)*J,_[6]=(D*G-O*q-L*B)*J,_[7]=(C*q-I*G+R*B)*J,_[8]=(T*$-E*Z+S*Y)*J,_[9]=(P*Z-V*$-F*Y)*J,_[10]=(O*H-j*G+L*z)*J,_[11]=(U*G-C*H-R*z)*J,_[12]=(E*W-T*X-k*Y)*J,_[13]=(V*X-P*W+x*Y)*J,_[14]=(j*B-O*N-D*z)*J,_[15]=(C*N-U*B+I*z)*J),this.needUpdateProjMat=!0}}]),e}()),m={left:0,middle:1,right:2},d={minZoom:.5,maxZoom:10,zoomScale:.02,rotateSpeed:.8},p=function(){function i(t,e){var V=this,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};y(this,i),this.camera=t,this.canvasElem=e,this.options=n(n({},d),r),this.minPolarAngle=-Math.PI/2,this.maxPolarAngle=Math.PI/2,this.minAzimuthAngle=-Math.PI,this.maxAziumthAngle=Math.PI,this.rotateStart=null,this.rotateEnd=null,this.onMousedown=function(t){switch(t.preventDefault(),t.button){case m.left:V.rotateStart=x([t.clientX,t.clientY]),V.canvasElem.addEventListener("mousemove",V.onMousemove,!1),V.canvasElem.addEventListener("mouseup",V.onMouseup,!1)}},this.onMousemove=function(t){V.rotateEnd=x([t.clientX,t.clientY]);var e,r,i,n,a,o=F(P(),V.rotateEnd,V.rotateStart),s=V.canvasElem,c=s.clientHeight,h=s.clientWidth,l=V.maxAziumthAngle,u=V.minAzimuthAngle,f=V.maxPolarAngle,v=V.minPolarAngle,m=V.options.rotateSpeed/V.camera.zoom,d=m*(l-u)*o[0]/c,p=m*(f-v)*o[1]/h,g=V.camera.position,y=(e=g,r=V.camera.target,i=r[0]-e[0],n=r[1]-e[1],a=r[2]-e[2],Math.hypot(i,n,a)),b=Math.atan2(g[2],g[0])+d,A=Math.asin(g[1]/y)+p,A=Math.min(Math.max(A,V.minPolarAngle),V.maxPolarAngle),M=y*Math.cos(A)*Math.sin(b),_=y*Math.cos(A)*Math.cos(b),w=y*Math.sin(A);V.camera.setPosition(_,w,M),V.rotateStart=x(V.rotateEnd)},this.onMouseup=function(){V.canvasElem.removeEventListener("mousemove",V.onMousemove,!1),V.canvasElem.removeEventListener("mouseup",V.onMouseup,!1)},this.onMousewheel=function(t){t.preventDefault(),t.stopPropagation();var e=V.camera.zoom,r=t.deltaY,i=V.options,n=i.minZoom,a=i.maxZoom,o=i.zoomScale;(t.deltaY<-.2||.2<t.deltaY)&&(e=Math.max(n,Math.min(a,e*(1-o*r)))),V.camera.setZoom(e)}}return r(i,[{key:"start",value:function(){this.canvasElem.addEventListener("mousedown",this.onMousedown,!1),this.canvasElem.addEventListener("wheel",this.onMousewheel,!1),this.canvasElem.addEventListener("mouseleave",this.onMouseup,!1)}},{key:"dispose",value:function(){this.canvasElem.removeEventListener("mousedown",this.onMousedown,!1),this.canvasElem.removeEventListener("whell",this.onMousewheel,!1),this.canvasElem.removeEventListener("mousemove",this.onMousemove,!1),this.canvasElem.removeEventListener("mouseup",this.onMouseup,!1),this.canvasElem.removeEventListener("mouseleave",this.onMouseup,!1)}}]),i}(),g=function(){function u(t){var e=t.ambientColor,r=void 0===e?[1,1,1]:e,i=t.ambientIntensity,n=void 0===i?1:i,a=t.diffuseColor,o=void 0===a?[1,1,1]:a,s=t.diffuseIntensity,c=void 0===s?1:s,h=t.position,l=void 0===h?[0,0,0]:h;y(this,u),this.ambientColor=f(r),this.ambientIntensity=n,this.diffuseColor=f(o),this.diffuseIntensity=c,this.position=f(l),this.needUpdatePosition=!0}return r(u,[{key:"setPosition",value:function(t,e,r){this.position=f([t,e,r]),this.needUpdatePosition=!0}}]),u}();function b(t,e,r){var i=t.createShader(e);try{if(t.shaderSource(i,r),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS))return console.log("Failed to compile shader".concat(t.getShaderInfoLog(i))),t.deleteShader(i),null}catch(t){console.log(t)}return i}var A=function(){function i(t,e,r){y(this,i),this.gl=t,this.program=function(t,e,r){var i=b(t,t.VERTEX_SHADER,e),n=b(t,t.FRAGMENT_SHADER,r);if(!i||!n)return null;var a=t.createProgram();return a?(t.attachShader(a,i),t.attachShader(a,n),t.linkProgram(a),t.getProgramParameter(a,t.LINK_STATUS)?a:(console.log("Failed to link program: ".concat(t.getProgramInfoLog(a))),t.deleteProgram(a),null)):null}(t,e,r),this.gl.useProgram(this.program)}return r(i,[{key:"destroy",value:function(){this.gl.deleteProgram(this.program),this.program=void 0,this.cachedAttributes=void 0,this.cachedUniforms=void 0}},{key:"uniforms",get:function(){return void 0===this.cachedUniforms&&(this.cachedUniforms=function(t,e){for(var r=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),i={},n=0;n<r;n++){var a=t.getActiveUniform(e,n);i[a.name]=t.getUniformLocation(e,a.name)}return i}(this.gl,this.program)),this.cachedUniforms}},{key:"attributes",get:function(){return void 0===this.cachedAttributes&&(this.cachedAttributes=function(t,e){for(var r=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),i={},n=0;n<r;n++){var a=t.getActiveAttrib(e,n);i[a.name]=t.getAttribLocation(e,a.name)}return i}(this.gl,this.program)),this.cachedAttributes}}]),i}();function M(t,e){var r=1<arguments.length&&void 0!==e?e:1;if(!/^#([A-Fa-f0-9]{3}){1,2}$/.test(t))throw new Error("Hex format mistake");var i=t.substring(1).split("");return 3===i.length&&(i=[i[0],i[0],i[1],i[1],i[2],i[2]]),[((i="0x".concat(i.join("")))>>16&255)/255,(i>>8&255)/255,(255&i)/255,Math.max(Math.min(r,1),0)]}var T=function(){function i(t,e){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:100;if(y(this,i),!t||t.length<2)throw Error("ColorRamp parameter colours have at least two item");this.colours=t,this.minValue=this.colours[0].offset,this.maxValue=this.colours[this.colours.length-1].offset,this.type=void 0!==e?e:"classified","stretched"===e?(this.intervalNum=r,this.gradients=this.createGradients(),this.colourAt=this.colourAtGradients):"classified"===e&&(this.intervals=this.createIntervals(),this.colourAt=this.colourAtIntervals)}return r(i,[{key:"createGradients",value:function(){var t=document.createElement("canvas");t.width=this.intervalNum,t.height=1;for(var e=t.getContext("2d"),r=e.createLinearGradient(0,0,this.intervalNum,0),i=this.maxValue-this.minValue,n=0,a=this.colours.length;n<a;n++){var o=(this.colours[n].offset-this.minValue)/i;r.addColorStop(o,this.colours[n].color)}return e.fillStyle=r,e.fillRect(0,0,this.intervalNum,1),e.getImageData(0,0,this.intervalNum,1).data}},{key:"colourAtGradients",value:function(t,e){var r=this.minValue,i=this.maxValue,n=this.intervalNum,a=(Math.max(t,r)-r)/(i-r)*n,o=4*Math.floor(a),s=this.gradients.slice(o,4+o);e[0]=s[0]/255,e[1]=s[1]/255,e[2]=s[2]/255}},{key:"createIntervals",value:function(){return this.colours.map(function(t){return{offset:t.offset,color:M(t.color)}})}},{key:"colourAtIntervals",value:function(t){for(var e,r=0,i=this.intervals.length-1;1<i-r;)e=Math.floor((i+r)/2),this.intervals[e].offset<=t?r=e:i=e;return this.intervals[r].color}}]),i}(),E={Triangle:1,Diamond:2,Hexagon:3},k=function(){function o(t){var e=t.canvas,r=t.camera,i=t.light,n=t.vertexShader,a=t.fragmentShader;y(this,o),this.geometries=[],this.canvas=e,this.camera=r,this.light=i,this.gl=function(t){for(var e=["webgl","experimental-webgl","webkit-3d","moz-webgl"],r=null,i=0,n=e.length;i<n;i++){try{r=t.getContext(e[i])}catch(t){}if(r)break}return r}(this.canvas),this.gl.getExtension("OES_standard_derivatives"),this.gl.enable(this.gl.DEPTH_TEST),this.updateShader(n,a),this.updateLightProgram()}return r(o,[{key:"updateShader",value:function(t,e){this.program=new A(this.gl,t,e)}},{key:"updateLightProgram",value:function(){var t,e,r=this.program.uniforms,i=h(_(),this.light.ambientColor,this.light.ambientIntensity);(t=this.gl).uniform3f.apply(t,[r.u_ambientProduct].concat(a(i)));var n=h(_(),this.light.diffuseColor,this.light.diffuseIntensity);(e=this.gl).uniform3f.apply(e,[r.u_diffuseProduct].concat(a(n)))}},{key:"addGeometry",value:function(t){this.geometries.push(t)}},{key:"clearGeometry",value:function(){this.geometries=[]}},{key:"render",value:function(){var t=this.gl;t.clearColor(1,1,1,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);var e=this.program.uniforms;this.camera.needUpdateViewMat&&(t.uniformMatrix4fv(e.u_viewMatrix,!1,this.camera.viewMatrix),this.camera.needUpdateViewMat=!1),this.camera.needUpdateProjMat&&(t.uniformMatrix4fv(e.u_projectionMatrix,!1,this.camera.projectionMatrix),this.camera.needUpdateProjMat=!1),this.light.needUpdatePosition&&(t.uniform3f.apply(t,[e.u_lightPosition].concat(a(this.light.position))),this.light.needUpdatePosition=!1),this.light.needUpdateProgram&&(this.updateLightProgram(),this.light.needUpdateProgram=!1);for(var r=0,i=this.geometries.length;r<i;r++)this.renderGeometry(this.geometries[r])}},{key:"renderGeometry",value:function(t){var e=this.gl,r=this.program.attributes,i=this.program.uniforms,n=t.attributes;if(e.uniform1i(i.u_wireframe,t.wireframe),e.uniform1i(i.u_partition,E[t.partition]),1===t.colours.length)e.uniform1i(i.u_colours,!1),e.uniform4fv(i.u_fragColor,M(t.colours[0].color));else{if(0===t.colours.length)throw Error("Geometry colours is empty");e.uniform1i(i.u_colours,!0)}n.position&&n.position.needUpdate&&(n.position.buffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.position.buffer),e.bufferData(e.ARRAY_BUFFER,n.position.array,e.STATIC_DRAW),e.enableVertexAttribArray(r.a_position),e.vertexAttribPointer(r.a_position,3,e.FLOAT,!1,0,0),n.position.needUpdate=!1),n.normal&&n.normal.needUpdate&&(n.normal.buffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.normal.buffer),e.bufferData(e.ARRAY_BUFFER,n.normal.array,e.STATIC_DRAW),e.enableVertexAttribArray(r.a_normal),e.vertexAttribPointer(r.a_normal,3,e.FLOAT,!1,0,0),n.normal.needUpdate=!1),n.barycentric&&n.barycentric.needUpdate&&(n.barycentric.buffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.barycentric.buffer),e.bufferData(e.ARRAY_BUFFER,n.barycentric.array,e.STATIC_DRAW),e.enableVertexAttribArray(r.a_barycentric),e.vertexAttribPointer(r.a_barycentric,3,e.FLOAT,!1,0,0),n.barycentric.needUpdate=!1),t.wireframe||e.disableVertexAttribArray(r.a_barycentric),n.color&&n.color.needUpdate&&(n.color.buffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.color.buffer),e.bufferData(e.ARRAY_BUFFER,n.color.array,e.STATIC_DRAW),e.enableVertexAttribArray(r.a_color),e.vertexAttribPointer(r.a_color,n.color.itemSize,e.FLOAT,!1,0,0),n.color.needUpdate=!1),e.drawArrays(e.TRIANGLES,0,n.position.count)}}]),o}(),S=Object.freeze({__proto__:null,Camera:v,Control:p,Light:g,Renderer:k}),C=Math.PI/180,U=6371e3;function I(t,e){var r=(t[0]+e[0])/2,i=(t[1]+e[1])/2,n=(t[2]+e[2])/2,a=Math.sqrt(r*r+i*i+n*n),o=U/a;return[r*o,i*o,n*o]}function R(t,e,r,i){var n=3<arguments.length&&void 0!==i?i:[],a=(t[0]+e[0]+r[0])/3,o=(t[1]+e[1]+r[1])/3,s=(t[2]+e[2]+r[2])/3,c=Math.sqrt(a*a+o*o+s*s);return n[0]=a/c,n[1]=o/c,n[2]=s/c,n}function O(t,e,r){return[(t[0]+e[0]+r[0])/3,(t[1]+e[1]+r[1])/3,(t[2]+e[2]+r[2])/3]}var j=function(){function i(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:3,r=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];y(this,i),this.array=t,this.itemSize=e,this.normalized=r,this.count=this.array.length/e,this.needUpdate=!0,this.updateRange={offset:0,count:-1},this.offset=0}return r(i,[{key:"insertVec3",value:function(t){this.array[this.offset++]=t[0],this.array[this.offset++]=t[1],this.array[this.offset++]=t[2]}}]),i}(),D=function(){function g(t){var e=t.polyhedronType,r=void 0===e?"Octahedron":e,i=t.partition,n=void 0===i?"Triangle":i,a=t.level,o=void 0===a?0:a,s=t.wireframe,c=void 0!==s&&s,h=t.terrain,l=void 0!==h&&h,u=t.terrainScale,f=void 0===u?100:u,v=t.colours,m=void 0===v?[{offset:0,color:"#ff0000"}]:v,d=t.field,p=void 0===d?[]:d;switch(y(this,g),this.attributes={},this.polyhedronType=r,this.partition=n,this.level=o,this.terrain=l,this.terrainScale=f,this.polyhedronType){case"Tetrahedron":this.initVertices=[];break;case"Octahedron":this.initVertices=[[[[0,-180],[90,-135]],[[-90,-135],[0,-90]]],[[[0,-90],[90,-45]],[[-90,-45],[0,0]]],[[[0,0],[90,45]],[[-90,45],[0,90]]],[[[0,90],[90,135]],[[-90,135],[0,180]]]];break;case"Icosahedron":this.initVertices=[];break;default:this.initVertices=[]}this.field=p,this.colours=m,this.updateVertices(),this.terrain&&this.createTerrain(),this.updateAttribute(),this.updateWireframe(c)}return r(g,[{key:"updatePartition",value:function(t){this.partition=t,this.updateAttribute(),this.updateWireframe(this.wireframe)}},{key:"updateLevel",value:function(t,e){this.level=t,this.field=e,this.updateVertices(),this.terrain&&this.createTerrain(),this.updateAttribute(),this.updateWireframe(this.wireframe)}},{key:"updateWireframe",value:function(t){var e;t?(this.wireframe=!0,e=this.attributes.position.array.length,this.attributes.barycentric&&this.attributes.barycentric.array.length===e?this.attributes.barycentric.needUpdate=!0:this.attributes.barycentric=this.createBarycentric(e)):this.wireframe=!1}},{key:"updateTerrain",value:function(t,e){var r=1<arguments.length&&void 0!==e?e:100;t?(this.terrain=!0,this.terrainScale=r,this.updateVertices(),this.createTerrain()):(this.terrain=!1,this.updateVertices()),this.updateAttribute()}},{key:"updateVertices",value:function(){this.vertices=[];for(var t,e,r,i,n,a,o,s=0,c=this.initVertices.length;s<c;s++){this.vertices[s]=new Array(2);for(var h=0;h<2;h++){this.vertices[s][h]=new Array(2);for(var l=0;l<2;l++)this.vertices[s][h][l]=(t=this.initVertices[s][h][l],o=a=n=i=r=e=void 0,e=t[0]*C,r=t[1]*C,i=Math.cos(e),n=Math.cos(r),a=Math.sin(e),o=Math.sin(r),[U*i*o,U*a,U*i*n])}for(var u=0;u<this.level;u++)this.vertices[s]=function(t){for(var e,r,i=2*t.length-1,n=new Array(i),a=0;a<i;a++)n[a]=new Array(i);for(var o=0;o<i;o+=2){e=Math.floor(o/2);for(var s=0;s<i;s++)r=Math.floor(s/2),n[o][s]=s%2==0?t[e][r]:I(t[e][r],t[e][r+1])}for(var c=1;c<i;c+=2)for(var h=0;h<i;h++)e=Math.floor(c/2),r=Math.floor(h/2),n[c][h]=h%2==0?I(n[c-1][h],n[c+1][h]):I(n[c-1][h-1],n[c+1][h+1]);return n}(this.vertices[s])}}},{key:"createTerrain",value:function(){for(var t,e,r,i,n,a=this.vertices.length,o=Math.pow(2,this.level)+1,s=0;s<a;s++)for(e=0;e<o;e++)for(t=0;t<o;t++)r=this.vertices[s][e][t],i=this.vertices[s][e][t],n=this.field[s][e][t]*this.terrainScale,h(r,i,(U+n)/U)}},{key:"updateAttribute",value:function(){switch(this.partition){case"Triangle":this.attributes.position=this.createTrianglePosition(),this.attributes.normal=this.createTriangleNormal(),1<this.colours.length&&(this.attributes.color=this.createTriangleColor());break;case"Diamond":this.attributes.position=this.createTrianglePosition(),this.attributes.normal=this.createDiamondNormal(),1<this.colours.length&&(this.attributes.color=this.createDiamondColor());break;case"Hexagon":this.attributes.position=this.createHexagonPosition(),this.attributes.normal=this.createHexagonNormal(),1<this.colours.length&&(this.attributes.color=this.createHexagonColor());break;default:throw Error("type error")}}},{key:"createTrianglePosition",value:function(){for(var t,e,r=Math.pow(2,this.level),i=this.vertices.length,n=new j(new Float32Array(r*r*i*6*3),3,!1),a=0;a<i;a++)for(t=0;t<r;t++)for(e=0;e<r;e++)n.insertVec3(this.vertices[a][t][e]),n.insertVec3(this.vertices[a][t+1][e]),n.insertVec3(this.vertices[a][t+1][e+1]),n.insertVec3(this.vertices[a][t+1][e+1]),n.insertVec3(this.vertices[a][t][e+1]),n.insertVec3(this.vertices[a][t][e]);return n}},{key:"createTriangleNormal",value:function(){for(var t=Math.pow(2,this.level),e=this.vertices.length,r=new j(new Float32Array(t*t*e*6*3),3,!1),i=Array(3),n=0;n<e;n++)for(var a=0;a<t;a++)for(var o=0;o<t;o++)R(this.vertices[n][a][o],this.vertices[n][a+1][o],this.vertices[n][a+1][o+1],i),r.insertVec3(i),r.insertVec3(i),r.insertVec3(i),R(this.vertices[n][a+1][o+1],this.vertices[n][a][o+1],this.vertices[n][a][o],i),r.insertVec3(i),r.insertVec3(i),r.insertVec3(i);return r}},{key:"createTriangleColor",value:function(){for(var t=Math.pow(2,this.level),e=this.field.length,r=new j(new Float32Array(t*t*e*6*3),3,!1),i=new T(this.colours,"stretched",100),n=Array(3),a=0;a<e;a++)for(var o=0;o<t;o++)for(var s=0;s<t;s++)i.colourAt((this.field[a][o][s]+this.field[a][o+1][s]+this.field[a][o+1][s+1])/3,n),r.insertVec3(n),r.insertVec3(n),r.insertVec3(n),i.colourAt((this.field[a][o+1][s+1]+this.field[a][o][s+1]+this.field[a][o][s])/3,n),r.insertVec3(n),r.insertVec3(n),r.insertVec3(n);return r}},{key:"createDiamondNormal",value:function(){for(var t,e,r,i,n,a,o=Math.pow(2,this.level),s=_(),c=this.vertices.length,h=new j(new Float32Array(o*o*c*6*3),3,!1),l=0;l<c;l++)for(var u=0;u<o;u++)for(var f=0;f<o;f++)t=s,e=w(_(),this.vertices[l][u][f],this.vertices[l][u+1][f+1],.5),a=n=i=r=void 0,r=e[0],i=e[1],n=e[2],0<(a=r*r+i*i+n*n)&&(a=1/Math.sqrt(a)),t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a,h.insertVec3(s),h.insertVec3(s),h.insertVec3(s),h.insertVec3(s),h.insertVec3(s),h.insertVec3(s);return h}},{key:"createDiamondColor",value:function(){for(var t=Math.pow(2,this.level),e=this.field.length,r=new j(new Float32Array(t*t*e*6*3),3,!1),i=new T(this.colours,"stretched",100),n=Array(3),a=0;a<e;a++)for(var o=0;o<t;o++)for(var s=0;s<t;s++)i.colourAt((this.field[a][o][s]+this.field[a][o+1][s]+this.field[a][o+1][s+1]+this.field[a][o+1][s+1])/4,n),r.insertVec3(n),r.insertVec3(n),r.insertVec3(n),r.insertVec3(n),r.insertVec3(n),r.insertVec3(n);return r}},{key:"createHexagonPosition",value:function(){for(var t=Math.pow(2,this.level),e=this.vertices.length,r=new j(new Float32Array(e*(10+16*(t-1)+(t-1)*(t-1)*6)*3*3),3,!1),i=[],n=[],a=0;a<e;a++){n[a]=[];for(var o=0;o<t;o++){n[a][o]=[];for(var s=0;s<t;s++)n[a][o][2*s]=O(this.vertices[a][o][s],this.vertices[a][o+1][s],this.vertices[a][o+1][s+1]),n[a][o][2*s+1]=O(this.vertices[a][o+1][s+1],this.vertices[a][o][s+1],this.vertices[a][o][s])}}for(var c=0;c<e;c++){i[c]=[[],[],[],[]];for(var h=c+1===4?0:c+1,l=c-1==-1?3:c-1,u=0;u<t;u++)i[c][0][u]=w(_(),n[c][0][2*u+1],n[l][t-1-u][2*t-1],.5);for(var f=0;f<t;f++)i[c][1][f]=w(_(),n[c][t-1][2*f],n[h][t-1-f][0],.5);for(var v=0;v<t;v++)i[c][2][v]=w(_(),n[c][v][0],n[l][t-1][2*(t-1-v)],.5);for(var m=0;m<t;m++)i[c][3][m]=w(_(),n[c][m][2*t-1],n[h][0][2*(t-1-m)+1],.5)}for(var d=0;d<e;d++){this.insertTriangleFan(r,this.vertices[d][0][0],[i[d][2][0],n[d][0][0],n[d][0][1],i[d][0][0]]),this.insertTriangleFan(r,this.vertices[d][0][t],[i[d][0][t-1],n[d][0][2*t-1],i[d][3][0]]),this.insertTriangleFan(r,this.vertices[d][t][0],[i[d][1][0],n[d][t-1][0],i[d][2][t-1]]),this.insertTriangleFan(r,this.vertices[d][t][t],[i[d][3][t-1],n[d][t-1][2*t-1],n[d][t-1][2*t-2],i[d][1][t-1]]);for(var p=1;p<t;p++)this.insertTriangleFan(r,this.vertices[d][0][p],[i[d][0][p-1],n[d][0][2*p-1],n[d][0][2*p],n[d][0][2*p+1],i[d][0][p]]);for(var g=1;g<t;g++)this.insertTriangleFan(r,this.vertices[d][t][g],[i[d][1][g],n[d][t-1][2*g],n[d][t-1][2*g-1],n[d][t-1][2*g-2],i[d][1][g-1]]);for(var y=1;y<t;y++)this.insertTriangleFan(r,this.vertices[d][y][0],[i[d][2][y],n[d][y][0],n[d][y][1],n[d][y-1][0],i[d][2][y-1]]);for(var b=1;b<t;b++)this.insertTriangleFan(r,this.vertices[d][b][t],[i[d][3][b-1],n[d][b-1][2*t-1],n[d][b-1][2*t-2],n[d][b][2*t-1],i[d][3][b]]);for(var A=1;A<t;A++)for(var M=1;M<t;M++)this.insertTriangleFan(r,this.vertices[d][A][M],[n[d][A][2*M-1],n[d][A][2*M],n[d][A][2*M+1],n[d][A-1][2*M],n[d][A-1][2*M-1],n[d][A-1][2*M-2],n[d][A][2*M-1]])}return r}},{key:"createHexagonNormal",value:function(){for(var t,e,r,i,n=Math.pow(2,this.level),a=this.vertices.length,o=new j(new Float32Array(a*(10+16*(n-1)+(n-1)*(n-1)*6)*3*3),3,!1),s=0;s<a;s++){for(i=this.vertices[s][0][0],r=0;r<9;r++)o.insertVec3(i);for(i=this.vertices[s][0][n],r=0;r<6;r++)o.insertVec3(i);for(i=this.vertices[s][n][0],r=0;r<6;r++)o.insertVec3(i);for(i=this.vertices[s][n][n],r=0;r<9;r++)o.insertVec3(i);for(t=1;t<n;t++)for(i=this.vertices[s][0][t],r=0;r<12;r++)o.insertVec3(i);for(t=1;t<n;t++)for(i=this.vertices[s][n][t],r=0;r<12;r++)o.insertVec3(i);for(t=1;t<n;t++)for(i=this.vertices[s][t][0],r=0;r<12;r++)o.insertVec3(i);for(t=1;t<n;t++)for(i=this.vertices[s][t][n],r=0;r<12;r++)o.insertVec3(i);for(e=1;e<n;e++)for(t=1;t<n;t++)for(i=this.vertices[s][e][t],r=0;r<18;r++)o.insertVec3(i)}return o}},{key:"createHexagonColor",value:function(){for(var t,e,r,i=Math.pow(2,this.level),n=this.vertices.length,a=new j(new Float32Array(n*(10+16*(i-1)+(i-1)*(i-1)*6)*3*3),3,!1),o=new T(this.colours,"stretched",100),s=Array(3),c=0;c<n;c++){for(o.colourAt(this.field[c][0][0],s),r=0;r<9;r++)a.insertVec3(s);for(o.colourAt(this.field[c][0][i],s),r=0;r<6;r++)a.insertVec3(s);for(o.colourAt(this.field[c][i][0],s),r=0;r<6;r++)a.insertVec3(s);for(o.colourAt(this.field[c][i][i],s),r=0;r<9;r++)a.insertVec3(s);for(t=1;t<i;t++)for(o.colourAt(this.field[c][0][t],s),r=0;r<12;r++)a.insertVec3(s);for(t=1;t<i;t++)for(o.colourAt(this.field[c][i][t],s),r=0;r<12;r++)a.insertVec3(s);for(t=1;t<i;t++)for(o.colourAt(this.field[c][t][0],s),r=0;r<12;r++)a.insertVec3(s);for(t=1;t<i;t++)for(o.colourAt(this.field[c][t][i],s),r=0;r<12;r++)a.insertVec3(s);for(e=1;e<i;e++)for(t=1;t<i;t++)for(o.colourAt(this.field[c][e][t],s),r=0;r<18;r++)a.insertVec3(s)}return a}},{key:"createBarycentric",value:function(t){for(var e=new j(new Float32Array(t),3,!1),r=t/9,i=0;i<r;i++)e.insertVec3([1,0,0]),e.insertVec3([0,1,0]),e.insertVec3([0,0,1]);return e}},{key:"insertTriangleFan",value:function(t,e,r){for(var i=0,n=r.length-1;i<n;i++)t.insertVec3(e),t.insertVec3(r[i]),t.insertVec3(r[i+1])}}]),g}(),L=function(){function e(t){y(this,e),this.playing=!1,this.preFrameTime=null,this.step=0,this.frameCount=void 0!==t.frameCount?t.frameCount:1/0,this.frameDuration=void 0!==t.frameDuration?t.frameDuration:16,this.circulation=void 0===t.circulation||t.circulation,this.animCallback=t.animCallback}return r(e,[{key:"start",value:function(){this.playing||(this.playing=!0,this.anim())}},{key:"stop",value:function(){this.playing=!1,this.step=0,cancelAnimationFrame(this.requestId)}},{key:"pasue",value:function(){this.playing=!1,cancelAnimationFrame(this.requestId)}},{key:"restart",value:function(){this.stop(),this.start()}},{key:"anim",value:function(){var r=this;requestAnimationFrame(function t(e){r.preFrameTime||(r.preFrameTime=e),1<=(e-r.preFrameTime)/r.frameDuration?(r.step<r.frameCount?(r.animCallback(r.step++),r.requestId=requestAnimationFrame(t)):(r.step=0,r.circulation&&(r.animCallback(r.step),r.requestId=requestAnimationFrame(t))),r.preFrameTime=e):r.requestId=requestAnimationFrame(t)})}}]),e}();t.Animation=L,t.Polyhedron=D,t.RADIUS=U,t.WebGLRenderer=S,t.standardFrament="\n#extension GL_OES_standard_derivatives : enable\nprecision mediump float;\n\nuniform bool u_wireframe;\nuniform int u_partition;\n\nvarying vec4 v_color;\nvarying vec3 v_barycentric;\n\nfloat edgeFactor(){\n\n    vec3 d = fwidth(v_barycentric);\n    vec3 a3 = smoothstep(vec3(0.0), d*1.0, v_barycentric);\n    float factor = 1.0;\n    if (u_partition == 1) {\n        // 三角形\n        factor = min(min(a3.x, a3.y), a3.z);\n    } else if (u_partition == 2) {\n        // 菱形\n        factor = min(a3.x, a3.z);\n    } else if (u_partition == 3) {\n        // 六边形\n        factor = a3.x;\n    }\n\n    return factor;\n}\n\nvoid main(){\n\n    if (u_wireframe) {\n        gl_FragColor = vec4(mix(vec3(1.0), v_color.rgb, edgeFactor()), v_color.a);\n\n        // if(any(lessThan(v_barycentric, vec3(0.05)))){\n        //     gl_FragColor = vec4(mix(vec3(1.0), v_color.rgb, edgeFactor()), v_color.a);//discard;\n        // }\n        // else{\n        //     gl_FragColor = v_color;\n        // }\n    } else {\n        gl_FragColor = v_color;\n    }\n}\n",t.standardVertex="\n\nattribute vec4 a_position;\nattribute vec3 a_normal;\nattribute vec3 a_barycentric;\nattribute vec4 a_color;\n\nuniform bool u_colours;\nuniform vec4 u_fragColor;\n\n// camera\nuniform mat4 u_viewMatrix;\nuniform mat4 u_projectionMatrix;\n\n// light\nuniform vec3 u_ambientProduct;\nuniform vec3 u_diffuseProduct;\nuniform vec3 u_lightPosition;\n\n\nvarying vec4 v_color;\nvarying vec3 v_barycentric;\n\nvoid main(){\n    gl_Position =  u_projectionMatrix * u_viewMatrix * a_position;  // u_xformMatrix * vec4(0.0, 0.0, 0.0, 1.0);\n\n    vec3 normal = normalize(a_normal);\n    vec3 lightDirection = normalize(u_lightPosition - a_position.xyz);\n\n    vec3 ambient = u_ambientProduct;\n    vec3 diffuse = u_diffuseProduct * max(dot(lightDirection, normal), 0.0);\n\n    if (u_colours) {\n        v_color = vec4((ambient + diffuse) * a_color.xyz, a_color.a);\n    } else {\n        v_color = vec4((ambient + diffuse) * u_fragColor.xyz, u_fragColor.a);\n    }\n\n\n    v_barycentric = a_barycentric;\n}\n",Object.defineProperty(t,"__esModule",{value:!0})});
